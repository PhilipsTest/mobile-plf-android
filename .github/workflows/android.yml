name: Android CI

on:
  workflow_dispatch:
    inputs:
      PSRA:
        description: 'Build with PSRA'
        required: false
        default: false
      LeakCanary:
        description: 'Build with LeakCanary'
        required: false
        default: false
      HPFortify:
        description: 'HP-Fortify'
        required: false
        default: false
           
  push:
    branches:
      - '**'
  pull_request:
    branches: [ feature/GitHub_Actions ]
  
  #Set your workflow to run every day of the week at 17:00 UTC(10:30 PM)
  schedule:
  - cron:  0 2 * * 0-6

jobs:
  Build:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
        clean: true
        submodules: true
        lfs: true
  
    - name: Build & Test with Gradle
      run: |
          #!/bin/bash -l
          set -e
          /bin/chmod -R 755 .
          pwd
          ./gradlew --refresh-dependencies --full-stacktrace clean assembleRelease \
            :AppInfra:testReleaseUnitTest \
            :uAppFwLib:testReleaseUnitTest \
            :registrationApi:testReleaseUnitTest \
            :product-registration-lib:testReleaseUnitTest \
            :iap:testReleaseUnitTest \
            :digitalCareUApp:testRelease \
            :digitalCare:testRelease \
            :mya:testReleaseUnitTest \
            :pif:testReleaseUnitTest \
            :pim:testReleaseUnitTest \
            :conversationalChatBot:testReleaseUnitTest \
            :philipsecommercesdk:testReleaseUnitTest \
            :mec:testReleaseUnitTest \
            :pimApp:testReleaseUnitTest \
            :referenceApp:testReleaseUnitTest
    
    - name: Upload APK
      uses: actions/upload-artifact@v2.2.0
      with:
        name: APK's for ReferenceApp & PIMDemoApp
        path: |
          ${{github.workspace}}/Source/rap/Source/AppFramework/appFramework/build/outputs/apk/release/*.apk
          ${{github.workspace}}/source/pim/Source/DemoApp/app/build/outputs/apk/release/*.apk
    
    #publish to artifactory only for master,develop and release/platform_*
    - name: Publish To Artifactory
      if: contains(github.ref, 'develop*''release/platform_*')        
      run: |
          ./gradlew --full-stacktrace saveResDep saveAllResolvedDependenciesGradleFormat zipDocuments artifactoryPublish :referenceApp:printArtifactoryApkPath :AppInfra:zipcClogs :securedblibrary:zipcClogs :pim:zipcClogs :conversationalChatBot:zipcClogs :registrationApi:zipcClogs :productselection:zipcClogs :digitalCareUApp:zipcClogs :digitalCare:zipcClogs :pimApp:zipcClogs
  
  PSRA-Build:
    if: github.event.inputs.PSRA == true || github.event_name == 'schedule'
    runs-on: self-hosted
    
    steps:
    - name: PSRABuildTest
      run: |
          ./gradlew referenceApp:assemblePsraRelease
          ./gradlew pimApp:assemblePsraRelease
    
    - name: Upload APK
      uses: actions/upload-artifact@v2.2.0
      with:
        name: APK's for ReferenceApp & PIMDemoApp
        path: |
          ${{github.workspace}}/Source/rap/Source/AppFramework/appFramework/build/outputs/psraRelease/referenceApp-psraRelease.apk
          ${{github.workspace}}/source/pim/Source/DemoApp/app/build/outputs/apk/release/*.apk
   
  LeakCanary-Build:
    if: github.event.inputs.LeakCanary == true
    runs-on: self-hosted
    
    steps:
    - name: LeakCanaryBuildTest
      run: |
           ./gradlew referenceApp:assembleLeakCanary
           ./gradlew pimApp:assembleLeakCanary
 
  HPFortify-Build:
    if: github.event.inputs.HPFortify == true || github.event_name == 'schedule'
    runs-on: self-hosted
    steps:
      - name: HP-Fortify-Build
        run: |
            #!/bin/bash -l
            set -e
            chmod -R 755 .
            ./gradlew --refresh-dependencies		
		        array=(

                'registrationApi::UR_Android'
                'mec::MEC_ANDROID'
                'AppInfra::AppInfra_Android'
                'digitalCare::CC_Android'
                'philipsecommercesdk::ECS_ANDROID'
                'iap::IAP_Android'
                'pif::plf_android'
			          'pim::PIM_Android'
			          'conversationalChatBot::CCB_ANDROID'
			          'product-registration-lib::PR_Android'
			          'prx::PRX_Android'
			          'securedblibrary::SecureDB_Android'
			          'uAppFwLib::uAppFwLib_Android'
            )
            for index in "${array[@]}" ; do
                KEY="${index%%::*}"
                VALUE="${index##*::}"
              echo "*** sourceanalyzer -b $KEY -clean ***"
              sourceanalyzer -b $KEY -clean    
              echo "*** sourceanalyzer -b $KEY -Xmx10G -Xss32M -debug-verbose -logfile $VALUE.txt ./gradlew $KEY:assembleRelease ***"
              sourceanalyzer -b $KEY -Xmx10G -Xss32M -debug-verbose -logfile $VALUE.txt ./gradlew clean $KEY:assembleRelease
              echo "*** sourceanalyzer -b $KEY -scan -f $VALUE.fpr ***"
              sourceanalyzer -b $KEY -Xmx10G -Xss32M -scan -f $VALUE.fpr
              echo "*** fortifyclient -url https://fortify.philips.com/ssc $VALUE***"
              fortifyclient -url https://fortify.philips.com/ssc -authtoken ea532fe0-0cc0-4111-9c9c-f8e5425c78b1 uploadFPR -file $VALUE.fpr -project EMS -version $VALUE
		        done
    

    
