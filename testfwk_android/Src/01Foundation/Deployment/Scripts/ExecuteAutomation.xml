<project name="IAP Functional Test" default="sendmail" basedir=".">
	
	<property file="AntTask.properties" />

	<tstamp>
		<format property="START_TIME" pattern="dd-MM-yyyy_HH-mm-ss"/>
	</tstamp>
	<property name="TestResult_Folder" value="${DailyTestReport}\${START_TIME}"/>

	<!-- Need to copy APK from the build folder then run Device admin disable command
		 Uninstall and install APK in the tablet. Enable Device Admin and then Login using adb shell commands
	-->

   <!-- delete previous run folders and files. Start clean execution -->
   <target name="clean" >
      <delete verbose="${full-compile}">
         <fileset dir="${LogPath}" includes="**/*.*" />
         <fileset dir="${RunningBuild}/" includes="**/*.apk" />
      </delete>
     
     <delete includeEmptyDirs="true">
       <fileset dir="${LogPath}" defaultexcludes="false">
         <include name="**/*310130188_*/**" />
       </fileset>
     </delete>
     
	   <mkdir dir="${TestResult_Folder}"/>
     <copy  file="${HomeLoc}\LatestAPK\ECPApp-release.apk" todir="${TestResult_Folder}"/>
     <copy  file="${HomeLoc}\LatestAPK\ECPApp-release.apk" todir="${RunningBuild}"/>
   </target>
   
<!--Run/Execute test cases and keep the raw results in the reports folder -->   
   <target name="test" depends="clean">
    <exec executable="C:\Program Files (x86)\Microsoft Visual Studio 11.0\Common7\IDE\mstest.exe"
          failonerror="false">
           <arg value="/testcontainer:${HomeLoc}\Bin\eCPAppFeatureTest.dll" />
           <arg value="/resultsfile:${LogPath}\TestResult.trx" />
      </exec>
   </target>

   <!--Generate specflow default html report from the raw results trx file  -->   
   <target name="report" depends="test">
		<exec executable="${HomeLoc}\Dependencies\tools\SpecFlow.exe" failonerror="false">
			<arg value="mstestexecutionreport" />
		  <arg value="${HomeLoc}\Src\Tests\eCPAppFeatureTest\eCPAppFeatureTest.csproj" />
			<arg value="/testResult:${LogPath}\TestResult.trx" />
			<arg value="/out:${LogPath}\TestResult.html" />
		</exec>
	</target>
	
	<target name="DailyFolder" depends="report">
    <copy todir="${TestResult_Folder}/Screenshots">
      <fileset dir="${LogPath}/Screenshots"/>
    </copy>
    <move todir="${TestResult_Folder}">
      <fileset dir="${LogPath}" includes="*.*"/>
    </move>    
	</target>
	
    <!--Send test execution status as mail attachment  depends="report" -->      
	<target	name="sendmail" depends="DailyFolder">	   		
  		<mail mailhost="${SERVER}" mailport="${PORT}" subject="${SUBJECT}" tolist="${TOLIST}" messagemimetype="text/html">
			<from address="${FROM}" />
			<replyto address="${REPLYTO}" />
 			<message>
        <![CDATA[
				Hi All,<br>
				<br>
				Please find the IAP Automation suite execution html report attached in this mail.<br>
				You can also see the log file and Apk used for testing, stored in this location.: file:${TestResult_Folder}.<br>
				<br>
				Thanks,<br>
				Team IAP	
			]]>  
      </message>
			<attachments>
				<fileset dir="${TestResult_Folder}/">
					<include name="**/TestResult.html" />
				</fileset>
			</attachments>
		</mail>
	</target>	
</project>